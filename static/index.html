<html>
  <head>
    <title>Hippo Framework</title>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/bootstrap@3.3.7/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.13/css/dataTables.bootstrap.min.css">
    <style type="text/css">
      button.btn-row{
        margin-top:3px;
      }
    </style>
    <script src="https://unpkg.com/jquery@3.1.1/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.13/js/dataTables.bootstrap.min.js"></script>
    <script type="text/javascript">

      var latest_tasks = [];

      function killTask(mesosId, btn) {
        $(btn).button('loading');
        $.get('/tasks/' + mesosId + '/kill/');
      }

      function deleteTask(mesosId, btn) {
        $(btn).button('loading');
        $.ajax({
          url:'/tasks/' + mesosId + '/',
          method:'DELETE'
        });
      }

      function findTask(mesosId) {
        for(t of latest_tasks) {
          if (t.mesos_id == mesosId) {
            return t
          }
        }
        return null;
      }

      function rerunTask(mesosId, btn) {
        $(btn).button('loading');
        var t = findTask(mesosId);
        if(t) {
          var new_task = Object.assign({},t);
          delete new_task.mesos_id;
          delete new_task.mesos_state;
          delete new_task.status_tstamp;
          postTask(new_task);
        }
      }

      function loadTaskModalFields(t) {
        if(t) {
          $("#inputDockerImage").val(t.container.docker.image);
          $("#inputCommand").val(t.cmd);
          $("#inputCpu").val(t.cpus);
          $("#inputMem").val(t.mem);
        }
      }

      function taskDetails(id, btn) {
        $(".tm-widget").show();
        $(".qm-widget").hide();
        loadTaskModalFields(findTask(id));
        $("#details-modal").modal();
      }

      function postTask(task) {
        $.ajax({
          type: 'POST',
          url: '/tasks/',
          data: JSON.stringify(task),
          contentType: "application/json",
          dataType: 'json'
        });
      }

      var latest_queues = [];
      var latest_queue_types = [];

      function deleteQueue(id, btn) {
        $(btn).button('loading');
        $.ajax({
          url:'/queues/' + id + '/',
          method:'DELETE'
        });
      }

      function enableQueue(id, btn) {
        $(btn).button('loading');
        $.getJSON('/queues/' + id + '/enable/');
      }

      function disableQueue(id, btn) {
        $(btn).button('loading');
        $.getJSON('/queues/' + id + '/disable/');
      }

      function findQueue(id) {
        for(q of latest_queues) {
          if (q.id == id) {
            return q
          }
        }
        return null;
      }

      function arrayChunks(a, size) {
        var chunks = [], i;
        for (i = 0; i < a.length; i += size) {
          chunks.push(a.slice(i, i + size));
        }
        return chunks;
      }

      function loadQueueSpecifics(q, t_ns) {
        $("#detailsModalQueueSpecifics").html("");
        var output = '';
        for (var qtype of latest_queue_types) {
          if (qtype.namespace == t_ns) {
            var input_tups = [];
            for (var input_name in qtype.inputs) {
              input_tups.push([input_name,qtype.inputs[input_name]]);
            }
            var input_chunks = arrayChunks(input_tups,2);
            for(var chunk of input_chunks) {
              output += '<div class="row">';
              for(var input of chunk) {
                var name = input[0];
                var details = input[1];
                var def = '';
                if(details.default != null) {
                  def = details.default;
                }
                output += `<div class="form-group col-xs-6">
                    <label>${details.label}</label>
                    <input id="inputQueueSpecific_${name}" type="${details.input}" class="form-control " placeholder="${def}" />
                  </div>`
              }
              output += '</div>\n';
            }
          }
        }
        $("#detailsModalQueueSpecifics").html(output);
      }

      function queueDetails(id, btn) {
        $(".tm-widget").hide();
        $(".qm-widget").show();
        loadQueueSpecifics(findQueue(q),'redis');
        $("#details-modal").modal();
      }

      function postQueue(queue) {
        $.ajax({
          type: 'POST',
          url: '/queues/',
          data: JSON.stringify(queue),
          contentType: "application/json",
          dataType: 'json'
        });
      }



      $( document ).ready(function() {

        $('#tasks_table').DataTable({
          stateSave: true,
          paginate:false,
          info: false,
          order: [[2, 'desc']]
        });

        function update_tasks() {
          $.getJSON('/tasks/',function(data) {
            data.reverse();
            latest_tasks = data;

            var task_rows = [];
            for (t of data) {
              var state_color = 'text-primary';
              if (['TASK_FAILED','TASK_LOST'].includes(t.mesos_state)) {
                state_color = 'text-danger';
              }
              if (['TASK_FINISHED','TASK_KILLED'].includes(t.mesos_state)) {
                state_color = 'text-success';
              }
              var dt_format = '';
              if(t.status_tstamp) {
                var dt = new Date(t.status_tstamp * 1000);
                dt_format = dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString();
              }
              var details_btn_html = `<button class="btn btn-xs btn-info btn-row" onclick="taskDetails('${t.mesos_id}',this)">
                    Details <span class="glyphicon glyphicon-cog"></span>
                  </button>`;
              var kill_btn_html = `<button class="btn btn-xs btn-warning btn-row" data-loading-text="Killing..." onclick="killTask('${t.mesos_id}',this)">
                    Kill <span class="glyphicon glyphicon-screenshot"></span>
                  </button>`;
              var delete_btn_html = `<button class="btn btn-xs btn-danger btn-row" data-loading-text="Deleting..." onclick="deleteTask('${t.mesos_id}',this)">
                    Delete <span class="glyphicon glyphicon-remove"></span>
                  </button>`;
              var run_again_btn_html = `<button class="btn btn-xs btn-success btn-row" data-loading-text="Starting..." onclick="rerunTask('${t.mesos_id}',this)">
                    Re-Run <span class="glyphicon glyphicon-play"></span>
                  </button>`;
              var btn_html = details_btn_html + ' ' + delete_btn_html + ' ' + run_again_btn_html;
              if(['TASK_RUNNING','TASK_STAGING'].includes(t.mesos_state)) {
                btn_html = details_btn_html + ' ' + kill_btn_html;
              }
              task_rows.push([
                t.mesos_id,
                '<p class="' + state_color + '">' + t.mesos_state + '</span>',
                dt_format,
                t.container.docker.image,
                t.cmd,
                btn_html
              ]);
            }
            var tbl = $('#tasks_table').DataTable();
            tbl.rows().remove();
            tbl.rows.add(task_rows).draw();
          });
        }

        update_tasks();
        setInterval(update_tasks, 3000);


        $('#queues_table').DataTable({
          stateSave: true,
          paginate:false,
          info: false,
          order: [[0, 'asc']]
        });

        function update_queues() {
          $.getJSON('/queues/',function(data) {
            latest_queues = data;
            var queue_rows = [];
            for (q of data) {
              var state_color = 'text-success';
              if (q.queue.status == 'DISABLED') {
                state_color = 'text-danger';
              }
              var dt_format = '';
              if(q.last_run_tstamp) {
                var dt = new Date(q.last_run_tstamp * 1000);
                dt_format = dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString();
              }
              var details_btn_html = `<button class="btn btn-xs btn-info btn-row" onclick="queueDetails('${q.id}',this)">
                    Details <span class="glyphicon glyphicon-cog"></span>
                  </button>`;
              var disable_btn_html = `<button class="btn btn-xs btn-warning btn-row" data-loading-text="Disabling..." onclick="disableQueue('${q.id}',this)">
                    Disable <span class="glyphicon glyphicon-pause"></span>
                  </button>`;
              var enable_btn_html = `<button class="btn btn-xs btn-success btn-row" data-loading-text="Enabling..." onclick="enableQueue('${q.id}',this)">
                    Enable <span class="glyphicon glyphicon-play"></span>
                  </button>`;
              var delete_btn_html = `<button class="btn btn-xs btn-danger btn-row" data-loading-text="Deleting..." onclick="deleteQueue('${q.id}',this)">
                    Delete <span class="glyphicon glyphicon-remove"></span>
                  </button>`;
              var btn_html =  details_btn_html + ' ' + disable_btn_html;
              if(q.queue.status == 'DISABLED') {
                btn_html = details_btn_html + ' ' + enable_btn_html + ' ' + delete_btn_html;
              }
              queue_rows.push([
                q.queue.name,
                q.id,
                '<p class="' + state_color + '">' + q.queue.status + '</span>',
                dt_format,
                q.queue.type,
                q.container.docker.image,
                q.cmd,
                btn_html
              ]);
            }
            var tbl = $('#queues_table').DataTable();
            tbl.rows().remove();
            tbl.rows.add(queue_rows).draw();
          });
        }

        update_queues();
        setInterval(update_queues, 3000);

        (function update_queue_types() {
          $.getJSON('/queuetypes/',function(data){
            latest_queue_types = data;
            var qtype_options = '';
            for(var qtype of latest_queue_types) {
              qtype_options += `<option value="${qtype.namespace}">${qtype.label}</option>\n`;
            }
            $("#selectQueueType").html(qtype_options)
;          })
        })();


        $('.dataTables_filter input[type="search"]').css({'width':'300px','display':'inline-block','font-size':'1.3em','height':'36px'}).
          parent().css({'float':'left'});
      });


    </script>
  </head>
  <body>
    <h2 style="padding-left:10px;">Hippo Framework</h2>
    <div id="app" style="padding-top:10px;">
      <ul class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active">
          <a href="#queues" aria-controls="queues" role="tab" data-toggle="tab">
            <h4>Queues</h4>
          </a>
        </li>
        <li role="presentation" style="padding-left:20px;">
          <a href="#tasks" aria-controls="tasks" role="tab" data-toggle="tab">
            <h4>Tasks</h4>
          </a>
        </li>
      </ul>

      <!-- Tab panes -->
      <div class="tab-content">
        <div role="tabpanel" class="tab-pane" id="tasks">
          <div class="row" style="padding:10px;">
            <div class="col-xs-12">
              <a href="#" class="add-task-btn btn btn-primary pull-right">Add Task <span class="glyphicon glyphicon-plus"></span></a>
              <table id="tasks_table" class="table table-bordered table-condensed">
                <thead>
                  <tr>
                    <th>Id</th>
                    <th>State</th>
                    <th>Updated</th>
                    <th>Image</th>
                    <th>Command</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <div role="tabpanel" class="tab-pane active" id="queues">
          <div class="row" style="padding:10px;">
            <div class="col-xs-12">
              <a href="#" class="add-queue-btn btn btn-primary pull-right">Add Queue <span class="glyphicon glyphicon-plus"></span></a>
              <table id="queues_table" class="table table-bordered table-condensed">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Task Id Prefix</th>
                    <th>Status</th>
                    <th>Last Poll</th>
                    <th>Type</th>
                    <th>Image</th>
                    <th>Command</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>

    </div>

    <div class="modal fade" id="details-modal">
      <div class="modal-dialog" style="width:700px;">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Queue</h4>
          </div>
          <div class="modal-body">
            <form role="form">
              <div id="detailsModalQueueInfo" class="qm-widget">
                <div class="row">
                  <div class="form-group col-xs-4">
                    <label>Queue Type</label>
                    <select class="form-control" id="selectQueueType">
                    </select>
                  </div>
                  <div class="form-group col-xs-4">
                    <label>Name</label>
                    <input id="inputQueueName" type="text" class="form-control" />
                  </div>
                  <div class="form-group col-xs-4">
                    <label>Task Prefix</label>
                    <input id="inputQueuePrefix" type="text" class="form-control" />
                  </div>
                </div>

                <div class="row">
                  <div class="form-group col-xs-6">
                    <label>Max Concurrent Tasks</label>
                    <input id="inputQueueMaxConcurrent" type="number" class="form-control" />
                  </div>
                  <div class="form-group col-xs-6">
                    <label>Polling Frequency Seconds</label>
                    <input id="inputQueueFrequency" type="number" class="form-control" />
                  </div>
                </div>
                <div class="row">
                  <div class="form-group col-xs-6">
                    <label>Batch Size</label>
                    <input id="inputQueueBatchSize" type="number" class="form-control" placeholder="0" />
                  </div>
                  <div class="form-group col-xs-6">
                    <label>Batch Seperator</label>
                    <input id="inputQueueBatchSeparator" type="text" class="form-control" placeholder="|" />
                  </div>
                </div>
              </div>

              <div id="detailsModalQueueSpecifics" class="qm-widget">

              </div>

              <div class="row">
                <div class="form-group col-xs-6">
                  <label>Image</label>
                  <input id="inputDockerImage" type="text" class="form-control" />
                  <span style="font-size:0.8em;font-style:italic;">Path to docker image and tag</span>
                </div>
                <div class="form-group col-xs-6">
                  <label>Command</label>
                  <input id="inputCommand" type="text" class="form-control" />
                  <span style="font-size:0.8em;font-style:italic;">Command to run in the container</span>
                </div>
              </div>

              <div class="row">
                <div class="form-group col-xs-6">
                  <label>Memory</label>
                  <input id="inputMem" type="number" class="form-control" />
                  <span style="font-size:0.8em;font-style:italic;">RAM to allocate to container</span>
                </div>
                <div class="form-group col-xs-6">
                  <label>CPU</label>
                  <input id="inputCpu" type="number" class="form-control" />
                  <span style="font-size:0.8em;font-style:italic;">CPU priority to allocate to container</span>
                </div>
              </div>

              <div class="row">
                <div class="form-group col-xs-12">
                  <label>Environment Variables</label>
                  <textarea id="textEnv" class="form-control" style="white-space:pre;" rows="3"></textarea>
                  <span style="font-size:0.8em;font-style:italic;">
                    Format is "VARNAME=VARVALUE", separate multiple variables with newlines
                  </span>
                </div>
              </div>

              <div class="row">
                <div class="form-group col-xs-12">
                  <label>Volumes</label>
                  <textarea id="textVolume" class="form-control" style="white-space:pre;" rows="3"></textarea>
                  <span style="font-size:0.8em;font-style:italic;">
                    Format is "host/path:container/path", separate multiple mounts with newlines
                  </span>
                </div>
              </div>

            </form>
            <div id="details-modal-error" class="callout callout-danger" style="display:none;margin-bottom:0px;">

            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cancel</button>
            <button id="runTaskBtn" type="button" class="btn btn-primary tm-widget" data-loading-text="Starting...">Run Task</button>
            <button id="saveQueueBtn" type="button" class="btn btn-primary qm-widget" data-loading-text="Saving...">Save</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
  </body>
</html>